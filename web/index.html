<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>midi2swstruct Web</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h1>ðŸŽ¹ MIDI â†’ Sandbox World Structure</h1>
  <p>Upload a MIDI file and get a `.structure` file ready for Sandbox World.</p>

  <div class="file-input-wrapper">
    <input type="file" id="midiInput" accept=".mid,.midi">
    <label for="midiInput">Choose MIDI File</label>
  </div>

  <button id="downloadBtn" disabled>Download .structure</button>

  <div id="status" class="status"></div>
</div>

<script type="module">
import init, { generate_sw_from_midi } from './pkg/midi2swstruct_wasm.js';

await init();

const input = document.getElementById('midiInput');
const downloadBtn = document.getElementById('downloadBtn');
const status = document.getElementById('status');
let currentData = null;

input.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  status.textContent = "Processing MIDI...";
  downloadBtn.disabled = true;

  try {
    const arrayBuffer = await file.arrayBuffer();
    currentData = generate_sw_from_midi(new Uint8Array(arrayBuffer), 0);
    status.textContent = `âœ… Ready! ${file.name} converted.`;
    downloadBtn.disabled = false;
  } catch (err) {
    console.error(err);
    status.textContent = `âŒ Error: ${err}`;
  }
});

downloadBtn.addEventListener('click', () => {
  if (!currentData) return;
  const blob = new Blob([currentData], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = input.files[0].name.replace(/\.[^/.]+$/, ".structure");
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
